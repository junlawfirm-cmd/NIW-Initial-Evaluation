<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NIW ì´ë‹ˆì…œ í‰ê°€ ë¶„ì„í‘œ | Law Office of Hong-min Jun</title>
  <meta name="description" content="NIW ì´ë‹ˆì…œ í‰ê°€ ë¶„ì„í‘œ(ë¬´ë£Œ: ì ìˆ˜/ìš”ì•½ Â· ìœ ë£Œ: ì „ëµ ë©”ëª¨/ë³´ì™„ ì²´í¬ë¦¬ìŠ¤íŠ¸) - Law Office of Hong-min Jun" />
  <style>
    :root{
      --bg:#ffffff;
      --panel:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --border:rgba(17,24,39,.12);

      --primary:#5b8cff;
      --primary2:#3d6df2;
      --accent:#f5d18a;
      --accent2:#e8b65e;

      --ok:#16a34a;
      --warn:#d97706;
      --danger:#dc2626;

      --shadow: 0 12px 36px rgba(17,24,39,.10);
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", Arial, sans-serif;
      background: var(--bg);
      color:var(--text);
    }
    .container{max-width:1120px; margin:0 auto; padding:0 18px}

    header{padding:18px 0 10px}
    .brandbar{
      display:flex; align-items:flex-start; justify-content:space-between;
      gap:14px; flex-wrap:wrap;
      padding:14px 16px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.92);
      border-radius:20px;
      box-shadow: var(--shadow);
    }
    .brand-title .name{font-weight:950; letter-spacing:-.2px; font-size:16px; line-height:1.2}
    .brand-title .motto{color:var(--muted); font-size:12.5px; line-height:1.25; margin-top:3px}
    .brand-title .licenses{color:rgba(17,24,39,.70); font-size:12px; line-height:1.25; margin-top:2px}
    .brand-right{display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end}
    .contact-pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      border:1px solid var(--border);
      background:rgba(17,24,39,.03);
      color:rgba(17,24,39,.78);
      font-size:12px; white-space:nowrap;
    }
    .contact-pill strong{color:var(--text)}
    .contact-pill .dot{
      width:6px; height:6px; border-radius:50%;
      background: var(--accent2);
      box-shadow:0 0 0 5px rgba(232,182,94,.18);
    }

    .pagehead{padding:14px 0 6px}
    h1{margin:0; font-size:22px; letter-spacing:-.4px}
    .subtitle{
      margin-top:6px;
      color:rgba(17,24,39,.70);
      font-size:13px; line-height:1.45; max-width: 980px;
    }
    .topbar{
      margin-top:12px;
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:9px 12px; border-radius:999px;
      border:1px solid var(--border);
      background:rgba(17,24,39,.02);
      color:rgba(17,24,39,.72);
      font-size:12px;
    }
    .pill strong{color:var(--text)}
    .btn{
      cursor:pointer;
      border:1px solid rgba(17,24,39,.15);
      background:#fff;
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      font-weight:900;
      font-size:13px;
      transition:.15s;
      box-shadow: 0 10px 24px rgba(17,24,39,.07);
    }
    .btn:hover{transform:translateY(-1px)}
    .btn.primary{
      background:linear-gradient(180deg, rgba(91,140,255,.95), rgba(61,109,242,.88));
      border-color:rgba(61,109,242,.35);
      color:#fff;
    }
    .btn.gold{
      background:linear-gradient(180deg, rgba(245,209,138,.98), rgba(232,182,94,.92));
      border-color:rgba(232,182,94,.45);
      color:#111827;
    }
    .btn.danger{
      background:linear-gradient(180deg, rgba(239,68,68,.95), rgba(220,38,38,.88));
      border-color:rgba(220,38,38,.35);
      color:#fff;
    }

    main{padding:10px 0 44px}
    .card{
      background:#fff;
      border:1px solid var(--border);
      border-radius: var(--radius);
      padding:14px 14px 12px;
      box-shadow: var(--shadow);
      overflow:hidden;
      margin-bottom:12px;
    }
    .card h2{
      margin:0 0 10px;
      font-size:15px;
      letter-spacing:-.1px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .score{
      color:rgba(17,24,39,.70);
      font-size:12px;
      font-weight:900;
      border:1px solid var(--border);
      background:rgba(17,24,39,.02);
      padding:6px 10px;
      border-radius:999px;
      white-space:nowrap;
    }

    .summary{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
      align-items:start;
    }
    @media (min-width: 980px){
      .summary{grid-template-columns: 1.35fr .65fr;}
    }
    .kpi{display:flex; gap:10px; flex-wrap:wrap; margin-top:8px}
    .result{
      margin-top:10px;
      padding:12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:rgba(17,24,39,.02);
      line-height:1.5;
      color:rgba(17,24,39,.80);
      font-size:13px;
    }
    .divider{height:1px; background:rgba(17,24,39,.08); margin:10px 0}
    .tiny{font-size:11.5px; color:rgba(17,24,39,.55)}
    .tag{
      display:inline-block;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(17,24,39,.02);
      color:rgba(17,24,39,.70);
      font-size:11px;
      font-weight:800;
    }

    /* paid */
    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(91,140,255,.30);
      background:rgba(91,140,255,.10);
      color:rgba(17,24,39,.85);
      font-size:12px;
      font-weight:950;
      margin-top:2px;
    }
    .paid{
      border-radius:14px;
      border:1px dashed rgba(232,182,94,.70);
      background:rgba(245,209,138,.18);
      padding:14px 16px;
      margin-top:10px;
      color:rgba(17,24,39,.92);
      font-size:13px;
      line-height:1.6;
      word-break:break-word;
    }
    .paid.locked{
      filter: blur(7px);
      user-select:none;
      pointer-events:none;
    }

    /* lock overlay */
    .memo-wrap{position:relative}
    .lock-overlay{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      padding:10px;
    }
    .lock-box{
      width:100%;
      max-width:560px;
      background:#fff;
      border:1px solid var(--border);
      border-radius:16px;
      padding:14px;
      text-align:left;
      box-shadow: 0 18px 60px rgba(0,0,0,.12);
    }
    .lock-box .title{font-weight:950; letter-spacing:-.2px; margin-bottom:6px;}
    .lock-box .desc{
      color:rgba(17,24,39,.70);
      font-size:12.5px;
      line-height:1.5;
      margin-bottom:10px;
    }

    .codebox{
      display:flex; gap:8px; align-items:center;
      padding:8px;
      border-radius:14px;
      border:1px solid rgba(232,182,94,.65);
      background:rgba(245,209,138,.18);
      flex-wrap:wrap;
    }
    .codebox input{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(17,24,39,.15);
      background:#fff;
      color:var(--text);
      min-width:240px;
      outline:none;
      font-size:13px;
    }

    /* section table */
    table{width:100%; border-collapse:collapse; font-size:13px; table-layout:fixed}
    th,td{padding:10px 8px; border-top:1px solid rgba(17,24,39,.08); vertical-align:top;}
    th{text-align:left; color:rgba(17,24,39,.60); font-weight:900;}
    th:nth-child(1), td:nth-child(1){width:44%;}
    th:nth-child(2), td:nth-child(2){width:84px;}
    th:nth-child(3), td:nth-child(3){width:auto;}
    .yesno{
      font-weight:900;
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(17,24,39,.02);
      font-size:12px;
    }
    .yes{color:rgba(22,163,74,.95)}
    .no{color:rgba(220,38,38,.92)}

    /* Modal */
    .modal{
      position:fixed; inset:0; display:none;
      align-items:center; justify-content:center;
      padding:16px;
      background:rgba(0,0,0,.40);
      z-index:9999;
    }
    .modal-box{
      width:100%;
      max-width:560px;
      border-radius:20px;
      border:1px solid rgba(255,255,255,.35);
      background:#fff;
      box-shadow: 0 24px 80px rgba(0,0,0,.22);
      padding:14px;
    }
    .modal-title{
      font-weight:950; letter-spacing:-.2px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:6px;
    }
    .modal-desc{color:rgba(17,24,39,.80); font-size:13px; line-height:1.55; margin-bottom:10px;}
    .modal-actions{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;}
    .xbtn{
      border:1px solid rgba(17,24,39,.18);
      background:rgba(17,24,39,.03);
      border-radius:12px;
      padding:6px 10px;
      cursor:pointer;
      color:rgba(17,24,39,.78);
      font-weight:900;
    }

    footer{padding:10px 0 26px; color:rgba(17,24,39,.60); font-size:12px}

    /* âœ… ì¸ì‡„ ì·¨ì•½ì  ë°©ì§€:
       - LOCKED ìƒíƒœì—ì„œëŠ” paid ì˜ì—­ì„ í”„ë¦°íŠ¸ì—ì„œ ìˆ¨ê¹€
       - UNLOCKED ìƒíƒœì—ì„œëŠ” ì¶œë ¥ ê°€ëŠ¥(ì˜ë¢°ì¸ì´ ì½”ë“œë¥¼ ì…ë ¥í•˜ê³  ë‚œ ë’¤ë§Œ)
    */
    @media print{
      .modal{display:none !important}
      .btn, .codebox, .pill{display:none !important}
      .card{box-shadow:none}
      body.paid-locked [data-paid]{display:none !important;}
      body.paid-locked #lockOverlay{display:none !important;}
    }
  </style>
</head>

<body class="paid-locked">
  <header class="container">
    <div class="brandbar">
      <div class="brand-left">
        <div class="brand-title">
          <div class="name">Law Office of Hong-min Jun</div>
          <div class="motto">Attorneys for foreign born individuals and small business owners!</div>
          <div class="licenses">Indiana Â· Illinois Attorney</div>
        </div>
      </div>
      <div class="brand-right">
        <span class="contact-pill"><span class="dot"></span><strong>askus@junlawfirm.com</strong></span>
        <span class="contact-pill">â˜ <strong>847-660-4233</strong></span>
        <span class="contact-pill">â˜ <strong>317-701-2768</strong></span>
      </div>
    </div>

    <div class="pagehead">
      <h1>NIW ì´ë‹ˆì…œ í‰ê°€ ë¶„ì„í‘œ <span class="tag">ë¬´ë£Œ: ì ìˆ˜/ìš”ì•½</span> <span class="tag">ìœ ë£Œ: ì „ëµ/ì²´í¬ë¦¬ìŠ¤íŠ¸</span></h1>
      <div class="subtitle" id="caseMeta">
        ì¼€ì´ìŠ¤ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤â€¦
      </div>

      <div class="topbar">
        <span class="pill">ì „ì²´ ì ìˆ˜: <strong id="totalScore">-</strong>/<span id="totalMax">-</span></span>
        <span class="pill">ìƒíƒœ: <strong id="statusText">-</strong></span>
        <button class="btn" type="button" onclick="window.print()">ğŸ–¨ ì¸ì‡„</button>
      </div>
    </div>
  </header>

  <main class="container">
    <section class="card summary">
      <div>
        <h2>ì¢…í•© ì´ˆê¸° íŒë‹¨ <span class="score" id="fitBadge">-</span></h2>

        <div class="kpi">
          <span class="pill">ì í•©ì„±: <strong id="fitLevel">-</strong></span>
          <span class="pill">ë³´ì™„ í›„ ê°€ëŠ¥ì„±: <strong id="improveLevel">-</strong></span>
          <span class="pill">EB-1 ì „í™˜: <strong id="eb1Level">-</strong></span>
          <span class="pill">ì „ëµì  ì ‘ê·¼: <strong id="strategyNeed">-</strong></span>
        </div>

        <div class="result" id="autoResult">-</div>

        <div class="divider"></div>
        <div class="subtitle" style="font-weight:900; margin-bottom:6px;">ì´í‰ ë©”ëª¨(ë¬´ë£Œ ê³µê°œ)</div>
        <div class="result" id="overallNoteBox">-</div>

        <div class="tiny" style="margin-top:8px;">
          â€» ë³¸ í˜ì´ì§€ì˜ ë¬´ë£Œ ì˜ì—­ì€ â€œì´ˆê¸° ì ìˆ˜/ìš”ì•½â€ì´ë©°, ìœ ë£Œ ì˜ì—­ì€ Unlock Code ì…ë ¥ ì‹œ ì—´ë¦½ë‹ˆë‹¤.
        </div>
      </div>

      <div>
        <h2>ìœ ë£Œ ì˜ì—­ <span class="score" id="paidState">LOCKED</span></h2>
        <div class="tiny" id="expiryInfo" style="margin-top:-4px;">ìœ íš¨ê¸°ê°„: -</div>

        <div class="codebox" style="margin-top:10px;">
          <input id="codeInput" placeholder="Unlock Code (ì˜ˆ: JUN-2026-001-ABCD)" autocomplete="off" />
          <button class="btn gold" id="applyCodeBtn" type="button">ì½”ë“œ ì ìš©</button>
          <button class="btn danger" id="lockNowBtn" type="button">ì ê¸ˆ</button>
        </div>

        <div class="tiny" style="margin-top:8px;">
          â€» ê²°ì œëŠ” Squareì—ì„œ ì²˜ë¦¬ë˜ë©°, ë³¸ í˜ì´ì§€ëŠ” ì¹´ë“œ ì •ë³´ë¥¼ ìˆ˜ì§‘/ì €ì¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        </div>

        <div class="memo-wrap" style="margin-top:10px;">
          <div class="badge">1) ì „ëµ ë©”ëª¨(ìœ ë£Œ)</div>
          <div class="paid locked" data-paid id="paidStrategy">-</div>

          <div class="badge" style="margin-top:12px;">2) ë³´ì™„ ì²´í¬ë¦¬ìŠ¤íŠ¸(ìœ ë£Œ)</div>
          <div class="paid locked" data-paid id="paidChecklist">-</div>

          <div class="lock-overlay" id="lockOverlay">
            <div class="lock-box">
              <div class="title">ğŸ”’ ìœ ë£Œ ì˜ì—­ì€ Unlock Codeë¡œë§Œ ì—´ë¦½ë‹ˆë‹¤</div>
              <div class="desc">
                Square ì¸ë³´ì´ìŠ¤ ê²°ì œ í™•ì¸ í›„ ë°œê¸‰ë˜ëŠ” <strong>Unlock Code</strong>ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.<br/>
                ì½”ë“œê°€ ì—†ìœ¼ë©´ ì „ëµ ë©”ëª¨/ë³´ì™„ ì²´í¬ë¦¬ìŠ¤íŠ¸ëŠ” ì—´ë¦¬ì§€ ì•ŠìŠµë‹ˆë‹¤.
              </div>
              <div class="tiny">â€» LOCKED ìƒíƒœì—ì„œëŠ” <strong>ì¸ì‡„ì—ë„ ìœ ë£Œ ë‚´ìš©ì´ í¬í•¨ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</strong></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="sections"></section>

    <footer>
      <div style="margin-top:10px">
        Â© Law Office of Hong-min Jun. This tool provides an initial evaluation framework and does not constitute legal advice.
      </div>
    </footer>
  </main>

  <!-- Modal -->
  <div class="modal" id="modal">
    <div class="modal-box">
      <div class="modal-title">
        <span id="modalTitle">ì•ˆë‚´</span>
        <button class="xbtn" id="modalClose">ë‹«ê¸°</button>
      </div>
      <div class="modal-desc" id="modalDesc">-</div>
      <div class="modal-actions">
        <button class="btn" id="modalOk">í™•ì¸</button>
      </div>
    </div>
  </div>

<script>
  // =========================================================
  // 0) Worker URL (ë³¸ì¸ Worker URLë¡œ ì„¤ì •)
  // =========================================================
  const WORKER_BASE_URL = "https://rough-thunder-0931.junlawfirm.workers.dev";

  // =========================================================
  // 1) Modal
  // =========================================================
  const modal = document.getElementById("modal");
  const modalTitle = document.getElementById("modalTitle");
  const modalDesc = document.getElementById("modalDesc");
  const modalClose = document.getElementById("modalClose");
  const modalOk = document.getElementById("modalOk");

  function showModal(title, desc){
    modalTitle.textContent = title;
    modalDesc.innerHTML = desc;
    modal.style.display = "flex";
  }
  function hideModal(){ modal.style.display = "none"; }
  modalClose.addEventListener("click", hideModal);
  modalOk.addEventListener("click", hideModal);
  modal.addEventListener("click", (e)=>{ if(e.target === modal) hideModal(); });

  function escapeHtml(s){
    return String(s || "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // =========================================================
  // 2) Case ë¡œë”©
  // =========================================================
  const params = new URLSearchParams(location.search);
  const caseId = params.get("id");

  if(!caseId){
    showModal("ì¼€ì´ìŠ¤ ì˜¤ë¥˜", "case.htmlì—ëŠ” ë°˜ë“œì‹œ <strong>?id=CASE_ID</strong>ê°€ í•„ìš”í•©ë‹ˆë‹¤.");
  }

  async function fetchCase(){
    const resp = await fetch(`${WORKER_BASE_URL}/case?id=${encodeURIComponent(caseId)}`, {
      method:"GET",
      headers:{ "Accept":"application/json" }
    });
    const data = await resp.json().catch(()=>({}));
    if(!data.ok){
      throw new Error(data.error || "ì¼€ì´ìŠ¤ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    }
    return data.case;
  }

  function renderCase(c){
    document.getElementById("caseMeta").innerHTML =
      `ê³ ê°ëª…: <strong>${escapeHtml(c.clientName || "-")}</strong> &nbsp;Â·&nbsp; ì´ë©”ì¼: <strong>${escapeHtml(c.clientEmail || "-")}</strong>`;

    const s = c.caseData?.summary || {};
    document.getElementById("totalScore").textContent = s.totalChecked ?? "-";
    document.getElementById("totalMax").textContent = s.totalMax ?? "-";
    document.getElementById("statusText").textContent = s.status ?? "-";
    document.getElementById("fitLevel").textContent = s.fitLevel ?? "-";
    document.getElementById("improveLevel").textContent = s.improveLevel ?? "-";
    document.getElementById("eb1Level").textContent = s.eb1Level ?? "-";
    document.getElementById("strategyNeed").textContent = s.strategyNeed ?? "-";
    document.getElementById("fitBadge").textContent =
      (s.fitLevel && s.fitLevel.includes("ë§¤ìš°")) ? "Strong" :
      (s.fitLevel && (s.fitLevel.includes("ë³´í†µ") || s.fitLevel.includes("ë†’ìŒ"))) ? "Viable" : "Needs work";

    document.getElementById("autoResult").innerHTML = s.autoResultHtml || "-";
    document.getElementById("overallNoteBox").textContent = c.caseData?.overallNote || "-";

    // ì„¹ì…˜ í…Œì´ë¸”
    const sections = c.caseData?.sections || [];
    const host = document.getElementById("sections");
    host.innerHTML = "";
    sections.forEach(sec=>{
      const card = document.createElement("section");
      card.className = "card";
      const max = sec.score?.max ?? 0;
      const chk = sec.score?.checked ?? 0;

      card.innerHTML = `
        <h2>${escapeHtml(sec.title || "")} <span class="score">${chk}/${max}</span></h2>
        <table>
          <thead>
            <tr>
              <th>í•­ëª©</th>
              <th>ê²°ê³¼</th>
              <th>ë¹„ê³ </th>
            </tr>
          </thead>
          <tbody>
            ${(sec.items || []).map(it=>{
              const yes = !!it.checked;
              return `
                <tr>
                  <td>${escapeHtml(it.text)}</td>
                  <td><span class="yesno ${yes ? "yes" : "no"}">${yes ? "âœ“" : "âœ•"}</span></td>
                  <td class="tiny">â€”</td>
                </tr>
              `;
            }).join("")}
          </tbody>
        </table>
      `;
      host.appendChild(card);
    });

    // ìœ ë£Œ ë‚´ìš©(ì¼€ì´ìŠ¤ ì €ì¥ë¶„)
    const pc = c.paidContent || {};
    document.getElementById("paidStrategy").innerHTML = pc.strategyMemoHtml ? pc.strategyMemoHtml : "(ìœ ë£Œ ì „ëµ ë©”ëª¨ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.)";
    document.getElementById("paidChecklist").innerHTML = pc.checklistHtml ? pc.checklistHtml : "(ìœ ë£Œ ì²´í¬ë¦¬ìŠ¤íŠ¸ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.)";
  }

  // =========================================================
  // 3) ìœ ë£Œ ì ê¸ˆ/í•´ì œ (48ì‹œê°„ í† í°)
  // =========================================================
  const TOKEN_KEY = "junlawfirm_paid_token_v1";
  const EXP_KEY   = "junlawfirm_paid_exp_v1";

  function fmtRemaining(ms){
    if(ms <= 0) return "ë§Œë£Œ";
    const totalSec = Math.floor(ms / 1000);
    const days = Math.floor(totalSec / 86400);
    const hours = Math.floor((totalSec % 86400) / 3600);
    const mins = Math.floor((totalSec % 3600) / 60);
    if(days > 0) return `${days}ì¼ ${hours}ì‹œê°„ ${mins}ë¶„`;
    return `${hours}ì‹œê°„ ${mins}ë¶„`;
  }

  function setExpiryUI(){
    const info = document.getElementById("expiryInfo");
    const exp = Number(localStorage.getItem(EXP_KEY) || 0);
    if(!exp){ info.textContent = "ìœ íš¨ê¸°ê°„: -"; return; }
    info.textContent = `ìœ íš¨ê¸°ê°„: ${fmtRemaining(exp - Date.now())} ë‚¨ìŒ`;
  }

  function lockPaid(){
    document.body.classList.add("paid-locked");
    document.querySelectorAll("[data-paid]").forEach(el=>el.classList.add("locked"));
    document.getElementById("lockOverlay").style.display = "flex";
    document.getElementById("paidState").textContent = "LOCKED";
    setExpiryUI();
  }

  function unlockPaid(){
    document.body.classList.remove("paid-locked");
    document.querySelectorAll("[data-paid]").forEach(el=>el.classList.remove("locked"));
    document.getElementById("lockOverlay").style.display = "none";
    document.getElementById("paidState").textContent = "UNLOCKED";
    setExpiryUI();
  }

  function normalizeCode(s){ return (s || "").trim().toUpperCase(); }

  async function applyUnlockCode(code){
    const v = normalizeCode(code);
    if(!v){
      showModal("ì½”ë“œ í•„ìš”", "Unlock Codeë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
      return;
    }

    // ì¼€ì´ìŠ¤ IDë¥¼ ê°™ì´ ë³´ëƒ„(Workerì—ì„œ ë¡œê¹…/ì¶”ì  ê°€ëŠ¥)
    try{
      const resp = await fetch(`${WORKER_BASE_URL}/redeem`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ code: v, caseId })
      });
      const data = await resp.json().catch(()=>({}));
      if(!data.ok){
        showModal("ì½”ë“œ í™•ì¸", escapeHtml(data.error || "ì½”ë“œê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤."));
        return;
      }

      localStorage.setItem(TOKEN_KEY, data.token);
      localStorage.setItem(EXP_KEY, String(data.exp));
      unlockPaid();
      showModal("í•´ì œ ì™„ë£Œ", `ìœ ë£Œ ì˜ì—­ì´ ì—´ë ¸ìŠµë‹ˆë‹¤.<br>ìœ íš¨ê¸°ê°„: <strong>${fmtRemaining(data.exp - Date.now())}</strong>`);
    }catch(e){
      showModal("ì„œë²„ ì—°ê²° ì˜¤ë¥˜", "ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
    }
  }

  async function verifyToken(){
    const token = (localStorage.getItem(TOKEN_KEY) || "").trim();
    if(!token){ lockPaid(); return; }

    try{
      const resp = await fetch(`${WORKER_BASE_URL}/verify`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ token })
      });
      const data = await resp.json().catch(()=>({}));
      if(!data.ok){ lockPaid(); return; }

      const exp = Number((data.payload && data.payload.exp) || 0);
      localStorage.setItem(EXP_KEY, String(exp));
      if(!exp || Date.now() >= exp){ lockPaid(); return; }
      unlockPaid();
    }catch(e){
      lockPaid();
    }
  }

  function forceLockNow(){
    localStorage.removeItem(TOKEN_KEY);
    localStorage.removeItem(EXP_KEY);
    lockPaid();
    showModal("ì ê¸ˆ ì™„ë£Œ", "ìœ ë£Œ ì˜ì—­ì´ ì ê²¼ìŠµë‹ˆë‹¤.");
  }

  document.getElementById("applyCodeBtn").addEventListener("click", ()=>{
    applyUnlockCode(document.getElementById("codeInput").value);
  });
  document.getElementById("lockNowBtn").addEventListener("click", forceLockNow);

  // =========================================================
  // 4) Init
  // =========================================================
  let CASE = null;
  (async ()=>{
    try{
      CASE = await fetchCase();
      renderCase(CASE);
      lockPaid();
      await verifyToken();
      setExpiryUI();
      setInterval(async ()=>{ await verifyToken(); setExpiryUI(); }, 60*1000);
    }catch(e){
      showModal("ì¼€ì´ìŠ¤ ë¡œë”© ì‹¤íŒ¨", escapeHtml(e.message || String(e)));
    }
  })();
</script>
</body>
</html>
